# 体力系统重构完成说明

## 重构背景
原有体力功能不完整，缺少核心的体力恢复机制和统一管理。重新实现了完整的体力系统。

## ✅ 新体力系统特性

### 1. **完整的体力管理器** (`HeartManager`)
- 单例模式，统一管理所有体力相关功能
- 集成到App核心系统中，通过 `App.heartManager` 访问
- 基于BaseSystem，支持完整的生命周期管理

### 2. **体力配置**
```typescript
MAX_HEART = 5;                      // 最大体力值：5点
HEART_RECOVER_INTERVAL = 5分钟;     // 恢复间隔：5分钟恢复1点
CHECK_INTERVAL = 1分钟;             // 检查频率：每1分钟检查一次
```

### 3. **体力自动恢复机制**
- ✅ 启动时检查离线恢复
- ✅ 每1分钟定期检查
- ✅ 精确的恢复时间计算
- ✅ 恢复后自动更新UI
- ✅ 支持长时间离线恢复

### 4. **体力消耗机制**
- ✅ 开始游戏消耗1点体力 (`challengeViewCmpt.onClick_playBtn`)
- ✅ 重新开始消耗1点体力 (`settingViewCmpt.onClick_replayBtn`)
- ✅ 体力不足自动提示并阻止操作
- ✅ 智能更新恢复计时器

### 5. **体力获取途径**
- ✅ **自动恢复**：每5分钟恢复1点
- ✅ **商店购买**：200金币购买1点体力
- ✅ **游戏胜利**：每次胜利奖励1点体力
- ✅ 体力上限保护（不超过5点）

### 6. **UI显示增强**
- ✅ 主页：显示 "3/5" 格式的体力
- ✅ 设置页面：显示 "x3 (04:32)" 格式（包含恢复倒计时）
- ✅ 实时更新显示
- ✅ 事件驱动的UI刷新

### 7. **数据持久化**
- ✅ 当前体力值：`StorageHelperKey.Heart`
- ✅ 恢复时间戳：`StorageHelperKey.HeartRecoverTime`
- ✅ 初始体力设为5点（满血状态）

## 🔄 核心流程

### 体力恢复流程
1. 游戏启动 → 检查离线时间 → 计算可恢复数量 → 恢复体力 → 更新UI
2. 运行中每1分钟检查一次恢复条件
3. 满体力时停止恢复检查

### 体力消耗流程
1. 用户操作 → 检查体力充足性 → 消耗体力 → 更新恢复计时器 → 更新UI
2. 体力不足时显示提示并阻止操作

### 体力获取流程
1. 各种获取途径 → 增加体力（不超上限）→ 更新UI → 通知相关系统

## 📁 关键文件更新

### 新增文件
- `assets/script/core/heartManager.ts` - 体力管理器核心实现

### 修改文件
- `assets/script/core/app.ts` - 集成HeartManager和TimeController
- `assets/script/utils/storageHelper.ts` - 添加HeartRecoverTime存储键，初始体力改为5
- `assets/script/const/eventName.ts` - 添加HeartUpdate事件
- `assets/script/game/ui/challengeViewCmpt.ts` - 开始游戏时消耗体力
- `assets/script/game/ui/settingViewCmpt.ts` - 重新开始消耗体力，增强体力显示
- `assets/script/game/ui/homeViewCmpt.ts` - 监听体力更新，增强显示格式
- `assets/script/game/ui/buyViewCmpt.ts` - 使用新的体力管理器购买体力
- `assets/script/game/ui/resultViewCmpt.ts` - 游戏胜利时奖励体力

## 🎮 用户体验提升

### 1. **更合理的体力设计**
- 最大5点体力，提供足够的游戏次数
- 5分钟恢复间隔，平衡游戏节奏
- 多种获取途径，降低体力压力

### 2. **更好的反馈机制**
- 实时显示体力和恢复倒计时
- 体力不足时明确提示
- 胜利时奖励体力，提升成就感

### 3. **更智能的管理**
- 离线时间自动计算恢复
- 精确的时间管理
- 事件驱动的UI更新

## 🔧 技术优势

### 1. **架构设计**
- 单例模式确保唯一实例
- 基于BaseSystem的标准生命周期
- 事件驱动的松耦合设计

### 2. **性能优化**
- 定时检查而非实时计算
- 智能的更新触发机制
- 高效的时间计算算法

### 3. **可扩展性**
- 清晰的接口设计
- 易于添加新的体力获取途径
- 支持未来功能扩展

## 🎯 验证测试

### 测试场景
1. **启动测试**：关闭游戏数小时后重启，验证离线恢复
2. **消耗测试**：开始游戏和重新开始是否正确消耗体力
3. **获取测试**：购买体力、游戏胜利是否正确增加体力
4. **UI测试**：各界面体力显示是否正确和实时更新
5. **边界测试**：体力为0时的操作限制，满体力时的获取处理

### 预期结果
- 体力系统完全按设计工作
- UI显示准确及时
- 用户体验流畅自然
- 系统稳定可靠

体力系统重构完成，现在具备了完整的体力管理功能！