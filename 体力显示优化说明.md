# 体力显示优化完成说明

## 🎯 需求分析

### 原需求
- **设置页面**: 只显示体力数量，不要倒计时
- **主页地图**: 显示"3/5"格式，非满体力时显示倒计时
- **倒计时**: 动态更新，实时显示最近一个体力的恢复时间

## ✅ 实现方案

### 1. **设置页面体力显示**

**修改位置**: `assets/script/game/ui/settingViewCmpt.ts`

**修改前**:
```typescript
updateHeartInfo() {
    const currentHeart = App.heartManager.getCurrentHeart();
    const maxHeart = App.heartManager.getMaxHeart();
    const countdown = App.heartManager.getNextRecoverCountdown();
    
    let heartText = `x${currentHeart}`;
    if (currentHeart < maxHeart && countdown > 0) {
        const timeStr = App.heartManager.formatCountdown(countdown);
        heartText += ` (${timeStr})`;
    }
    
    CocosHelper.updateLabelText(this.lbHeart, heartText);
}
```

**修改后**:
```typescript
/** 更新体力显示 - 设置页面只显示数量 */
updateHeartInfo() {
    if (this.lbHeart) {
        const currentHeart = App.heartManager.getCurrentHeart();
        CocosHelper.updateLabelText(this.lbHeart, `x${currentHeart}`);
    }
}
```

### 2. **主页体力显示格式**

**修改位置**: `assets/script/game/ui/homeViewCmpt.ts`

**新的显示格式**:
```typescript
/** 更新体力显示 - 主页显示格式为 "3/5" 带倒计时 */
updateHeartInfo() {
    const currentHeart = App.heartManager.getCurrentHeart();
    const maxHeart = App.heartManager.getMaxHeart();
    let heartText = `${currentHeart}/${maxHeart}`;
    
    // 如果不是满体力，显示下次恢复倒计时
    if (currentHeart < maxHeart) {
        const countdown = App.heartManager.getNextRecoverCountdown();
        if (countdown > 0) {
            const timeStr = App.heartManager.formatCountdown(countdown);
            heartText += `\n${timeStr}`;  // 换行显示倒计时
        }
        
        // 启动倒计时更新定时器
        this.startHeartUpdateTimer();
    } else {
        // 满体力时停止定时器
        this.stopHeartUpdateTimer();
    }
    
    CocosHelper.updateLabelText(this.lbLife, heartText);
}
```

### 3. **动态倒计时更新机制**

**定时器管理**:
```typescript
private heartUpdateTimer: any = null; // 体力倒计时更新定时器

/** 启动体力倒计时更新定时器 */
startHeartUpdateTimer() {
    // 如果已经有定时器在运行，先清除
    if (this.heartUpdateTimer) {
        return;
    }
    
    // 每秒更新一次倒计时
    this.heartUpdateTimer = setInterval(() => {
        const currentHeart = App.heartManager.getCurrentHeart();
        const maxHeart = App.heartManager.getMaxHeart();
        
        if (currentHeart >= maxHeart) {
            // 满体力时停止定时器
            this.stopHeartUpdateTimer();
            this.updateHeartInfo();
            return;
        }
        
        let heartText = `${currentHeart}/${maxHeart}`;
        const countdown = App.heartManager.getNextRecoverCountdown();
        if (countdown > 0) {
            const timeStr = App.heartManager.formatCountdown(countdown);
            heartText += `\n${timeStr}`;
        }
        
        CocosHelper.updateLabelText(this.lbLife, heartText);
    }, 1000);
}

/** 停止体力倒计时更新定时器 */
stopHeartUpdateTimer() {
    if (this.heartUpdateTimer) {
        clearInterval(this.heartUpdateTimer);
        this.heartUpdateTimer = null;
    }
}
```

### 4. **生命周期管理**

**页面切换时的定时器管理**:
```typescript
evtPageView(pv: PageView) {
    let pageIndex = pv.getCurrentPageIndex();
    if (pageIndex == 2) { // 主页是索引2
        this.setHomeInfo();
    } else {
        // 离开主页时停止体力倒计时定时器
        this.stopHeartUpdateTimer();
    }
}

onDestroy() {
    // ... 其他清理代码
    
    // 清理体力更新定时器
    if (this.heartUpdateTimer) {
        clearInterval(this.heartUpdateTimer);
        this.heartUpdateTimer = null;
    }
}
```

## 🎮 用户体验效果

### 设置页面
- **简洁显示**: 只显示 `x3`、`x4`、`x5` 这种格式
- **专注功能**: 用户专注于设置操作，不被倒计时干扰

### 主页地图
- **完整信息**: 显示 `3/5` 这种清晰的体力状态
- **动态倒计时**: 
  - 满体力时：只显示 `5/5`
  - 非满体力时：显示 `3/5` 上方显示 `04:32` 倒计时
- **实时更新**: 倒计时每秒更新，用户可以实时看到剩余时间

### 显示示例

**满体力状态**:
```
5/5
```

**非满体力状态**:
```
3/5
04:32
```

**设置页面**:
```
x3
```

## 🔧 技术优势

### 1. **性能优化**
- 只在主页且非满体力时启动定时器
- 离开主页或达到满体力时自动停止定时器
- 避免不必要的UI更新

### 2. **内存安全**
- 完善的定时器清理机制
- 组件销毁时自动清理资源
- 避免内存泄漏

### 3. **用户体验**
- 不同页面显示不同详细程度的信息
- 主页提供最完整的体力信息和倒计时
- 设置页面保持简洁，专注功能

### 4. **响应式更新**
- 体力变化时立即更新显示
- 倒计时精确到秒级
- 满体力时自动停止倒计时

## 🎯 最终效果

现在体力显示系统具备：

- ✅ **设置页面**: 简洁的 `x3` 格式
- ✅ **主页地图**: 完整的 `3/5` 格式带动态倒计时  
- ✅ **实时更新**: 倒计时每秒刷新
- ✅ **智能管理**: 自动启动/停止定时器
- ✅ **内存安全**: 完善的资源清理机制

体力显示优化完成，现在用户可以在不同页面看到合适详细程度的体力信息！